{% extends "base.html" %}
{% load static %}

{% block title %}{% if item %}S·ª≠a b√†i vi·∫øt{% else %}T·∫°o b√†i vi·∫øt m·ªõi{% endif %}{% endblock %}

{% block extra_head %}
<!-- CropperJS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css">
<!-- Toast UI Image Editor -->
<link rel="stylesheet" href="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.css">

<style>
  .container--narrow{max-width:880px;margin:24px auto;padding:0 16px}
  .form-group{margin-bottom:16px}
  label{display:block;font-weight:600;margin-bottom:6px}
  input[type=text],input[type=url],textarea,input[type=file]{
    width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff
  }
  textarea{resize:vertical;min-height:140px}
  .btn{display:inline-block;border:1px solid #d1d5db;background:#f9fafb;border-radius:10px;padding:8px 14px;cursor:pointer}
  .btn-primary{background:#111827;color:#fff;border-color:#111827}
  .btn-danger{background:#dc2626;color:#fff;border-color:#dc2626}
  .note{font-size:12px;color:#6b7280;margin-left:8px}
  .img-preview{display:none;margin-top:10px;max-width:100%;max-height:420px;border-radius:12px}
  .toolbar{display:flex;gap:10px;align-items:center;margin-top:8px}

  /* Modal Image Editor */
  #imgEditorModal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:9999}
  #imgEditorModal .modal-card{
    position:absolute;inset:5%;background:#fff;border-radius:14px;display:flex;flex-direction:column;overflow:hidden
  }
  #imgEditorModal .modal-head{
    padding:10px 12px;border-bottom:1px solid #eee;display:flex;gap:8px;align-items:center;justify-content:space-between
  }
  #tuiEditorWrap{position:relative;flex:1;min-height:60vh;overflow:hidden}
  #tuiEditorRoot{width:100%;height:100%}
</style>
{% endblock %}

{% block content %}
<div class="container--narrow">
  <h1 style="margin-bottom:14px">{% if item %}S·ª≠a b√†i vi·∫øt{% else %}T·∫°o b√†i vi·∫øt m·ªõi{% endif %}</h1>

  <form id="newsForm" method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <div class="form-group">
      <label for="{{ form.title.id_for_label }}">Ti√™u ƒë·ªÅ</label>
      {{ form.title }}
    </div>

    <div class="form-group">
      <label for="{{ form.body.id_for_label }}">N·ªôi dung</label>
      {{ form.body }}
    </div>

    <div class="form-group">
      <label for="{{ form.link_url.id_for_label }}">Link ngo√†i (tu·ª≥ ch·ªçn)</label>
      {{ form.link_url }}
    </div>

    <div class="form-group">
      <label for="{{ form.link_label.id_for_label }}">Nh√£n link (tu·ª≥ ch·ªçn)</label>
      {{ form.link_label }}
    </div>

    <div class="form-group">
      <label for="{{ form.image.id_for_label }}">·∫¢nh b√¨a</label>
      {{ form.image }}

      <div class="toolbar">
        <button type="button" class="btn" id="openEditorBtn" disabled>Ch·ªânh s·ª≠a ·∫£nh</button>
        <span class="note">B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a ·∫£nh (c·∫Øt/xoay/ƒë·ªô s√°ng/ƒë·ªô t∆∞∆°ng ph·∫£n...) tr∆∞·ªõc khi l∆∞u.</span>
      </div>

      <!-- Preview d√πng cho Cropper -->
      <img id="preview" class="img-preview" alt="Preview">

      <!-- Hidden crop fields -->
      {{ form.crop_x }}{{ form.crop_y }}{{ form.crop_w }}{{ form.crop_h }}
    </div>

    <div class="form-group">
      <label for="{{ form.is_published.id_for_label }}">Tr·∫°ng th√°i</label>
      {{ form.is_published }}
    </div>

    <div class="form-group" style="display:flex;gap:10px;flex-wrap:wrap">
      <button type="submit" class="btn btn-primary">L∆∞u</button>
      {% if item %}
        <a class="btn" href="{% url 'news:detail' item.slug %}">Hu·ª∑</a>
      {% else %}
        <a class="btn" href="{% url 'news:list' %}">Hu·ª∑</a>
      {% endif %}
    </div>
  </form>
</div>

<!-- Modal Image Editor -->
<div id="imgEditorModal">
  <div class="modal-card">
    <div class="modal-head">
      <strong>Ch·ªânh s·ª≠a ·∫£nh</strong>
      <div>
        <button type="button" class="btn" id="editorCancel">H·ªßy</button>
        <button type="button" class="btn btn-primary" id="editorSave">L∆∞u ch·ªânh s·ª≠a</button>
      </div>
    </div>
    <div id="tuiEditorWrap">
      <div id="tuiEditorRoot"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- JS libs -->
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script src="https://uicdn.toast.com/tui-image-editor/latest/tui-image-editor.min.js"></script>

<script>
(function(){
  const form    = document.getElementById('newsForm');
  const input   = document.getElementById("{{ form.image.id_for_label }}"); // id_image
  const preview = document.getElementById('preview');

  const cx = document.getElementById('id_crop_x');
  const cy = document.getElementById('id_crop_y');
  const cw = document.getElementById('id_crop_w');
  const ch = document.getElementById('id_crop_h');

  let cropper = null;

  // Khi ch·ªçn ·∫£nh: show preview + kh·ªüi t·∫°o Cropper
  input.addEventListener('change', () => {
    const file = input.files && input.files[0];
    if (!file) { preview.style.display='none'; if(cropper){cropper.destroy(); cropper=null;} return; }
    const url = URL.createObjectURL(file);
    preview.src = url;
    preview.style.display = 'block';

    if (cropper) cropper.destroy();
    cropper = new Cropper(preview, {
      viewMode: 1,
      autoCropArea: 1,
      responsive: true,
      background: false,
      aspectRatio: 16 / 9   // üëà c·ªë ƒë·ªãnh t·ªâ l·ªá crop 16:9
    });

    // b·∫≠t n√∫t Editor
    document.getElementById('openEditorBtn').disabled = false;
  });

  // Tr∆∞·ªõc khi submit: l·∫•y to·∫° ƒë·ªô g·ªëc t·ª´ Cropper ‚Üí ghi v√†o hidden inputs
  form.addEventListener('submit', function(){
    if (!cropper) { cx.value = cy.value = cw.value = ch.value = 0; return; }
    const d = cropper.getData(true);
    cx.value = Math.max(0, Math.round(d.x));
    cy.value = Math.max(0, Math.round(d.y));
    cw.value = Math.max(0, Math.round(d.width));
    ch.value = Math.max(0, Math.round(d.height));
  });

  /* =========================
   *  Toast UI Image Editor
   * ========================= */
  const openBtn      = document.getElementById('openEditorBtn');
  const modal        = document.getElementById('imgEditorModal');
  const editorRoot   = document.getElementById('tuiEditorRoot');
  const editorSave   = document.getElementById('editorSave');
  const editorCancel = document.getElementById('editorCancel');

  let editor = null, blobURL = null;

  function fileToURL(file){ return URL.createObjectURL(file); }
  function dataURLToBlob(dataURL){
    const parts = dataURL.split(','), mime = parts[0].match(/:(.*?);/)[1];
    const bin = atob(parts[1]); const len = bin.length; const u8 = new Uint8Array(len);
    for (let i=0;i<len;i++) u8[i] = bin.charCodeAt(i);
    return new Blob([u8], {type: mime});
  }
  async function replaceInputFile(fileInput, blob, filename){
    const file = new File([blob], filename, {type: blob.type});
    const dt = new DataTransfer();
    dt.items.add(file);
    fileInput.files = dt.files;
    fileInput.dispatchEvent(new Event('change'));
  }

  openBtn?.addEventListener('click', ()=>{
    const file = input.files && input.files[0];
    if (!file) return;
    blobURL = fileToURL(file);

    modal.style.display = 'block';
    if (editor) { try { editor.destroy(); } catch(e){} editor = null; editorRoot.innerHTML=''; }

    editor = new tui.ImageEditor(editorRoot, {
      includeUI: {
        loadImage: { path: blobURL, name: file.name || 'image' },
        menu: ['crop','rotate','flip','filter','draw','text','shape'],
        initMenu: 'crop',
        uiSize: { width: '100%', height: '100%' },
        menuBarPosition: 'bottom'
      },
      selectionStyle: { cornerSize: 12, rotatingPointOffset: 40 }
    });

    window.addEventListener('resize', ()=> editor.ui.resizeEditor());
  });

  editorCancel?.addEventListener('click', ()=>{
    modal.style.display = 'none';
    if (editor) { try { editor.destroy(); } catch(e){} editor = null; }
    if (blobURL) URL.revokeObjectURL(blobURL);
  });

  editorSave?.addEventListener('click', async ()=>{
    if (!editor) return;
    try{
      const dataURL = editor.toDataURL();
      const blob = dataURLToBlob(dataURL);
      const name = (input.files[0]?.name || 'edited.png').replace(/\.(jpe?g|png|webp|gif)$/i,'') + '_edited.png';
      await replaceInputFile(input, blob, name);
      [cx, cy, cw, ch].forEach(el => el && (el.value = 0));
      editorCancel.click();
    }catch(err){
      alert('Kh√¥ng th·ªÉ l∆∞u ·∫£nh ƒë√£ ch·ªânh s·ª≠a: ' + err);
    }
  });
})();
</script>
{% endblock %}
