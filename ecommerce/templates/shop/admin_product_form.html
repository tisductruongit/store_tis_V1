{% extends "base.html" %}
{% load static %}
{% block title %}{% if is_edit %}S·ª≠a s·∫£n ph·∫©m{% else %}Th√™m s·∫£n ph·∫©m{% endif %}{% endblock %}

{% block extra_head %}
<style>
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  @media (max-width:768px){.form-row{grid-template-columns:1fr}}
  .field{margin-bottom:12px}
  .field label{display:block;margin-bottom:6px;font-weight:600}
  .errors{color:#dc2626;margin:6px 0 0}
  .alert-error{border:1px solid #ef4444;color:#ef4444;padding:10px;border-radius:10px;margin:10px 0}
  .muted{color:var(--muted)}
  .thumbs{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .thumbs img{width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--line)}
  .preview-main{width:220px;height:220px;object-fit:cover;border-radius:12px;border:1px solid var(--line);background:#f8fafc}
  .image-card{display:flex;flex-direction:column;align-items:center;gap:6px;border:1px solid var(--line);border-radius:8px;padding:8px}
  .logo-box{display:flex;align-items:center;gap:10px;margin-top:6px}
  .logo-box img{max-height:80px;border:1px solid #e5e7eb;padding:4px;border-radius:6px;background:#fff}
</style>
{% endblock %}

{% block content %}
  <h1>{% if is_edit %}S·ª≠a s·∫£n ph·∫©m{% else %}Th√™m s·∫£n ph·∫©m{% endif %}</h1>

  {% if form.errors or images_form.errors %}
    <div class="alert-error">
      <b>Vui l√≤ng ki·ªÉm tra c√°c l·ªói sau:</b>
      <ul style="margin:6px 0 0 18px">
        {% for field in form %}
          {% for err in field.errors %}
            <li><b>{{ field.label }}:</b> {{ err }}</li>
          {% endfor %}
        {% endfor %}
        {% for err in form.non_field_errors %}<li>{{ err }}</li>{% endfor %}
        {% for err in images_form.non_field_errors %}<li>{{ err }}</li>{% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="mt-3">
    {% csrf_token %}

    <div class="form-row">
      <div>
        <div class="field">
          {{ form.category.label_tag }}{{ form.category }}
          {% for e in form.category.errors %}<div class="errors">{{ e }}</div>{% endfor %}
        </div>

        <div class="field">
          {{ form.name.label_tag }}{{ form.name }}
          <small id="name-check-hint" class="muted"></small>
          {% for e in form.name.errors %}<div class="errors">{{ e }}</div>{% endfor %}
        </div>

        <div class="field">
          {{ form.slug.label_tag }}{{ form.slug }}
          <div class="muted" style="margin-top:4px">Vui l√≤ng kh√¥ng ch·ªânh s·ª≠a n·∫øu kh√¥ng c·∫ßn thi·∫øt</div>
          {% for e in form.slug.errors %}<div class="errors">{{ e }}</div>{% endfor %}
        </div>

        {% if form.supplier %}
        <div class="field">
          {{ form.supplier.label_tag }}{{ form.supplier }}
          <div class="logo-box">
            <span class="muted">Logo:</span>
            <img id="supplierLogo" src="" alt="" style="display:none">
          </div>
          {% for e in form.supplier.errors %}<div class="errors">{{ e }}</div>{% endfor %}
        </div>
        {% endif %}

        <div class="field">
          {{ form.price.label_tag }}{{ form.price }}
          {% comment %} <div class="muted" style="margin-top:4px">Ch·ªâ nh·∫≠p s·ªë. H·ªó tr·ª£ 40.000, 1.234,56, 40000.75‚Ä¶</div> {% endcomment %}
          {% for e in form.price.errors %}<div class="errors">{{ e }}</div>{% endfor %}
        </div>

        <div class="field">
          {{ form.stock.label_tag }}{{ form.stock }}
          {% for e in form.stock.errors %}<div class="errors">{{ e }}</div>{% endfor %}
        </div>
      </div>

      <div>
        <div class="field">
          <label for="id_image">·∫¢nh ƒë·∫°i di·ªán</label>
          {{ form.image }}
          {% for e in form.image.errors %}<div class="errors">{{ e }}</div>{% endfor %}
          <div class="mt-2">
            <img id="mainPreview" class="preview-main"
                 {% if is_edit and product.image %}src="{{ product.image.url }}"{% endif %}
                 alt="">
          </div>
        </div>

        <div class="field">
          <label for="id_images">·∫¢nh b·ªï sung (c√≥ th·ªÉ ch·ªçn nhi·ªÅu)</label>
          {{ images_form.images }}
          <div class="muted" style="margin-top:4px">Gi·ªØ Ctrl ƒë·ªÉ ch·ªçn nhi·ªÅu ·∫£nh.</div>
          {% for e in images_form.images.errors %}<div class="errors">{{ e }}</div>{% endfor %}
          <div id="extraThumbs" class="thumbs"></div>
        </div>
      </div>
    </div>

    {% if is_edit and product.images.all %}
      <div class="field">
        <p><b>·∫¢nh hi·ªán c√≥</b> (tick ƒë·ªÉ xo√°):</p>
        <div class="thumbs">
          {% for im in product.images.all %}
            <label class="image-card">
              <img src="{{ im.image.url }}" alt="">
              <input type="checkbox" name="delete_images" value="{{ im.id }}"> Xo√°
            </label>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <div class="field">
      {{ form.description.label_tag }}{{ form.description }}
      {% for e in form.description.errors %}<div class="errors">{{ e }}</div>{% endfor %}
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
      <button id="submitBtn" type="submit" class="btn btn-primary">{% if is_edit %}C·∫≠p nh·∫≠t{% else %}L∆∞u{% endif %}</button>
      <a href="{% url 'shop:product_list' %}" class="btn btn-outline">H·ªßy</a>
      {% if is_edit %}
        <a href="{% url 'shop:admin_product_delete' product.id %}" class="btn btn-light">Xo√°‚Ä¶</a>
      {% endif %}
    </div>
  </form>
{% endblock %}

{% block extra_js %}
{% get_static_prefix as STATIC_PREFIX %}
<script>
  // ===== Helpers =====
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // ===== Ch·∫∑n Enter g√¢y submit ngo√†i √Ω mu·ªën & xo√° autosave khi submit =====
  (function(){
    const form = document.querySelector('form[method="post"]');
    if(!form) return;
    form.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        const tag = (e.target.tagName || '').toLowerCase();
        if(tag !== 'textarea'){ e.preventDefault(); }
      }
    });
    form.addEventListener('submit', ()=>{
      const key = window.__PRODUCT_FORM_KEY || 'shop_admin_product_form_draft';
      try{ localStorage.removeItem(key); }catch(_){}
    });
  })();

  // ===== Auto-slug t·ª´ Name (n·∫øu slug ch∆∞a s·ª≠a tay) =====
  (function(){
    const nameInput = document.getElementById('id_name');
    const slugInput = document.getElementById('id_slug');
    if(!nameInput || !slugInput) return;

    let slugTouched = false;
    slugInput.addEventListener('input', ()=> { slugTouched = true; });

    function toSlug(str){
      if(!str) return '';
      return str.normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')   // b·ªè d·∫•u
        .replace(/[^a-zA-Z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'')
        .toLowerCase();
    }
    nameInput.addEventListener('input', ()=>{
      if(!slugTouched || !slugInput.value){
        slugInput.value = toSlug(nameInput.value);
      }
    });
  })();

  // ===== Preview LOGO theo Supplier (th·ª≠ nhi·ªÅu ƒëu√¥i) =====
  (function(){
    const supplierInput = document.getElementById('id_supplier');
    const logoImg = document.getElementById('supplierLogo');
    if(!supplierInput || !logoImg) return;

    const MIN_LEN = 3;                 // <= ch·ªâ b·∫Øt ƒë·∫ßu load khi >= 3 k√Ω t·ª±
    const exts = ['png','jpg','jpeg','svg','webp'];

    function hideLogo(){
      logoImg.style.display='none';
      logoImg.removeAttribute('src');
      logoImg.alt='';
    }

    function tryLoad(urls, idx){
      if(idx >= urls.length){ hideLogo(); return; }
      const probe = new Image();
      probe.onload = function(){
        logoImg.src = urls[idx];
        logoImg.alt = 'Logo ' + (supplierInput.value || '').trim();
        logoImg.style.display = 'block';
      };
      probe.onerror = function(){ tryLoad(urls, idx+1); };
      probe.src = urls[idx];
    }

    function buildCandidates(name){
      const raw = (name || '').trim();
      if(!raw) return [];
      const bases = [raw, raw.toLowerCase()];
      const urls = [];
      bases.forEach(b=>{
        exts.forEach(ext=>{
          urls.push("{{ STATIC_PREFIX }}logo/" + encodeURIComponent(b) + "." + ext);
        });
      });
      return urls;
    }

    function updateLogo(){
      const val = (supplierInput.value || '').trim();
      if(val.length < MIN_LEN){ hideLogo(); return; }   // üî¥ NG·∫ÆN H∆†N 3 K√ù T·ª∞ => KH√îNG LOAD
      const urls = buildCandidates(val);
      if(urls.length === 0){ hideLogo(); return; }
      tryLoad(urls, 0);
    }

    const updDeb = (fn, ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
    const updateDebounced = updDeb(updateLogo, 300); // debounce 300ms ƒë·ªÉ h·∫°n ch·∫ø request

    supplierInput.addEventListener('input', updateDebounced);
    supplierInput.addEventListener('change', updateLogo);
    supplierInput.addEventListener('blur', updateLogo);

    // Khi m·ªü trang edit: v·∫´n ch·ªâ load n·∫øu ƒë·ªß 3 k√Ω t·ª±
    updateLogo();
  })();

  // ===== Preview ·∫£nh ƒë·∫°i di·ªán =====
  (function(){
    const input = document.getElementById('id_image');
    const preview = document.getElementById('mainPreview');
    if(!input || !preview) return;
    input.addEventListener('change', ()=>{
      const f = input.files && input.files[0];
      if(!f){ preview.removeAttribute('src'); preview.alt=''; return; }
      preview.src = URL.createObjectURL(f);
      preview.alt = f.name;
    });
  })();

  // ===== Preview ·∫£nh b·ªï sung (multiple) =====
  (function(){
    const input = document.getElementById('id_images');
    const box = document.getElementById('extraThumbs');
    if(!input || !box) return;
    input.addEventListener('change', ()=>{
      box.innerHTML = '';
      const files = Array.from(input.files || []);
      files.forEach(f=>{
        const img = document.createElement('img');
        img.src = URL.createObjectURL(f);
        img.alt = f.name;
        box.appendChild(img);
      });
    });
  })();

  // ===== Ki·ªÉm tra tr√πng t√™n realtime (disable n√∫t L∆∞u n·∫øu tr√πng) =====
  (function(){
    const input = document.getElementById('id_name');
    const hint  = document.getElementById('name-check-hint');
    const submitBtn = document.getElementById('submitBtn');
    if(!input || !hint || !submitBtn) return;

    const excludeId = "{{ product.id|default:'' }}";

    const check = debounce(()=>{
      const name = (input.value || '').trim();
      hint.textContent = '';
      submitBtn.disabled = false;
      if(!name){ return; }

      const url = new URL("{% url 'shop:check_product_name' %}", window.location.origin);
      url.searchParams.set('name', name);
      if(excludeId) url.searchParams.set('exclude', excludeId);

      fetch(url, {headers: {'X-Requested-With': 'XMLHttpRequest'}})
        .then(r=>r.json())
        .then(data=>{
          if(data.exists){
            hint.textContent = 'T√™n s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i. Vui l√≤ng ch·ªçn t√™n kh√°c.';
            hint.style.color = '#dc2626';
            submitBtn.disabled = true;
          }else{
            hint.textContent = 'T√™n h·ª£p l·ªá.';
            hint.style.color = 'var(--muted)';
            submitBtn.disabled = false;
          }
        })
        .catch(()=>{});
    }, 300);

    input.addEventListener('input', check);
    check();
  })();

  // ===== Autosave/Autorestore form v√†o localStorage =====
  (function(){
    const form = document.querySelector('form[method="post"]');
    if(!form) return;

    const pageKey = "{{ is_edit|yesno:'edit,new' }}";
    const objId   = "{{ product.id|default:'new' }}";
    const storageKey = `shop_admin_product_form_draft_${pageKey}_${objId}`;
    window.__PRODUCT_FORM_KEY = storageKey;

    const fields = {
      category:  document.getElementById('id_category'),
      name:      document.getElementById('id_name'),
      slug:      document.getElementById('id_slug'),
      supplier:  document.getElementById('id_supplier'),
      price:     document.getElementById('id_price'),
      stock:     document.getElementById('id_stock'),
      desc:      document.getElementById('id_description')
    };

    // Kh√¥i ph·ª•c
    try{
      const raw = localStorage.getItem(storageKey);
      if(raw){
        const data = JSON.parse(raw);
        if(fields.category && data.category) fields.category.value = data.category;
        if(fields.name && data.name) fields.name.value = data.name;
        if(fields.slug && data.slug) fields.slug.value = data.slug;
        if(fields.supplier && data.supplier) fields.supplier.value = data.supplier;
        if(fields.price && data.price) fields.price.value = data.price;
        if(fields.stock && data.stock) fields.stock.value = data.stock;
        if(fields.desc && data.desc) fields.desc.value = data.desc;
        // c·∫≠p nh·∫≠t logo sau kh√¥i ph·ª•c
        if(fields.supplier){
          const ev = new Event('input', {bubbles:true});
          fields.supplier.dispatchEvent(ev);
        }
      }
    }catch(_){}

    // L∆∞u nh√°p
    function saveDraft(){
      const data = {
        category: fields.category ? fields.category.value : '',
        name:     fields.name ? fields.name.value : '',
        slug:     fields.slug ? fields.slug.value : '',
        supplier: fields.supplier ? fields.supplier.value : '',
        price:    fields.price ? fields.price.value : '',
        stock:    fields.stock ? fields.stock.value : '',
        desc:     fields.desc ? fields.desc.value : ''
      };
      try{ localStorage.setItem(storageKey, JSON.stringify(data)); }catch(_){}
    }

    const deb = (fn, ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
    const saveDeb = deb(saveDraft, 200);

    Object.values(fields).forEach(el=>{
      if(!el) return;
      el.addEventListener('input', saveDeb);
      el.addEventListener('change', saveDraft);
      el.addEventListener('blur', saveDraft);
    });
  })();
</script>
{% endblock %}
