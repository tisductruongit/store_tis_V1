{% extends "base.html" %}
{% load static %}

{% block title %}{% if is_edit %}Sửa danh mục{% else %}Tạo danh mục{% endif %}{% endblock %}

{% block content %}
<div class="container" style="max-width:720px">
  <h1 style="margin-bottom:12px">
    {% if is_edit %}Sửa danh mục{% else %}Tạo danh mục{% endif %}
  </h1>

  <form method="post" novalidate>
    {% csrf_token %}

    <div class="form-group" style="margin-bottom:10px">
      <label for="id_name">Tên danh mục</label>
      {{ form.name }}
      {% if form.name.errors %}<div class="error">{{ form.name.errors }}</div>{% endif %}
    </div>

    <div class="form-group" style="margin-bottom:14px">
      <label for="id_slug">Slug</label>
      {{ form.slug }}
      <small class="text-muted">Không bắt buộc: nếu để trống sẽ tự sinh từ tên.</small>
      {% if form.slug.errors %}<div class="error">{{ form.slug.errors }}</div>{% endif %}
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button type="submit" class="btn btn-primary">
        {% if is_edit %}Lưu thay đổi{% else %}Tạo mới{% endif %}
      </button>

      {% if is_edit and category %}
        <a href="{% url 'shop:product_by_category' category.slug %}" class="btn btn-outline">Hủy</a>
        <!-- NÚT XOÁ ĐÚNG: dùng admin_category_delete + slug -->
        <a href="{% url 'shop:admin_category_delete' category.slug %}" class="btn btn-light"
           onclick="return confirm('Xoá danh mục này? Tất cả sản phẩm thuộc danh mục sẽ bị xoá theo (CASCADE).');">
          Xoá
        </a>
      {% else %}
        <a href="{% url 'shop:product_list' %}" class="btn btn-outline">Hủy</a>
      {% endif %}
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Auto-slug đơn giản từ tên (chỉ hỗ trợ cơ bản, backend vẫn đảm bảo unique)
  (function(){
    const nameInput = document.getElementById('id_name');
    const slugInput = document.getElementById('id_slug');
    if(!nameInput || !slugInput) return;

    function vnToSlug(str){
      return (str || '')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-zA-Z0-9]+/g,'-')
        .replace(/^-+|-+$/g,'')
        .toLowerCase();
    }

    // chỉ tự sinh khi slug đang trống hoặc vừa khớp auto trước đó
    let lastAuto = slugInput.value;
    nameInput.addEventListener('input', ()=>{
      if(!slugInput.value || slugInput.value === lastAuto){
        lastAuto = vnToSlug(nameInput.value);
        slugInput.value = lastAuto;
      }
    });
  })();
</script>
{% endblock %}
